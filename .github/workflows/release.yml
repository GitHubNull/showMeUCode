name: è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥vå¼€å¤´çš„tagæ—¶è§¦å‘ï¼Œå¦‚v1.0.0

jobs:
  release:
    name: æ„å»ºå¹¶å‘å¸ƒç‰ˆæœ¬
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºrelease
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—
        
    - name: è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ç¼“å­˜Mavenä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: æå–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        # ä»tagä¸­æå–ç‰ˆæœ¬å·ï¼ˆå»é™¤vå‰ç¼€ï¼‰
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "æå–çš„ç‰ˆæœ¬å·: $VERSION"
        
    - name: éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
      run: |
        if [[ ! "${{ steps.version.outputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "é”™è¯¯: ç‰ˆæœ¬å·æ ¼å¼æ— æ•ˆã€‚åº”è¯¥æ˜¯x.y.zæ ¼å¼ï¼Œå¦‚1.0.0"
          exit 1
        fi
        echo "ç‰ˆæœ¬å·æ ¼å¼éªŒè¯é€šè¿‡: ${{ steps.version.outputs.version }}"
        
    - name: æ›´æ–°pom.xmlç‰ˆæœ¬å·
      run: |
        # æ›´æ–°Mavené¡¹ç›®ç‰ˆæœ¬å·
        mvn versions:set -DnewVersion=${{ steps.version.outputs.version }} -DgenerateBackupPoms=false
        echo "å·²æ›´æ–°pom.xmlç‰ˆæœ¬å·ä¸º: ${{ steps.version.outputs.version }}"
        
    - name: ç¼–è¯‘å’Œæ‰“åŒ…
      run: |
        echo "å¼€å§‹ç¼–è¯‘é¡¹ç›®..."
        mvn clean compile
        echo "å¼€å§‹æ‰“åŒ…é¡¹ç›®..."
        mvn package -DskipTests
        
    - name: éªŒè¯æ„å»ºäº§ç‰©
      run: |
        JAR_FILE="target/showMeUCode-${{ steps.version.outputs.version }}.jar"
        if [ ! -f "$JAR_FILE" ]; then
          echo "é”™è¯¯: JARæ–‡ä»¶ä¸å­˜åœ¨: $JAR_FILE"
          exit 1
        fi
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        ls -la target/*.jar
        echo "JARæ–‡ä»¶å¤§å°: $(du -h $JAR_FILE | cut -f1)"
        
    - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
      id: changelog
      run: |
        echo "æ­£åœ¨ç”Ÿæˆå˜æ›´æ—¥å¿—..."
        
        # è·å–ä¸Šä¸€ä¸ªtag
        PREVIOUS_TAG=$(git tag --sort=-version:refname | head -2 | tail -1)
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "è¿™æ˜¯ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œä½¿ç”¨æ‰€æœ‰æäº¤è®°å½•"
          PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
        fi
        
        echo "ä» $PREVIOUS_TAG åˆ° ${{ steps.version.outputs.tag }} çš„å˜æ›´:"
        
        # ç”Ÿæˆå˜æ›´æ—¥å¿—
        CHANGELOG=$(cat << 'EOF'
        ## ğŸš€ ç‰ˆæœ¬ ${{ steps.version.outputs.version }} å‘å¸ƒè¯´æ˜
        
        ### ğŸ“¦ æ„å»ºä¿¡æ¯
        - **ç‰ˆæœ¬å·**: ${{ steps.version.outputs.version }}
        - **å‘å¸ƒæ—¥æœŸ**: $(date '+%Yå¹´%mæœˆ%dæ—¥')
        - **Javaç‰ˆæœ¬**: 17
        - **æ„å»ºå·¥å…·**: Maven
        
        ### ğŸ”„ ä¸»è¦å˜æ›´
        EOF
        )
        
        # æ·»åŠ æäº¤è®°å½•
        git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..${{ steps.version.outputs.tag }} >> changelog_temp.md
        
        # æ£€æŸ¥æ˜¯å¦æœ‰docs/release-notes.mdæ–‡ä»¶
        if [ -f "docs/release-notes.md" ]; then
          echo "" >> changelog_temp.md
          echo "### ğŸ“‹ è¯¦ç»†å‘å¸ƒè¯´æ˜" >> changelog_temp.md
          echo "è¯·æŸ¥çœ‹ [å®Œæ•´å‘å¸ƒè¯´æ˜](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/docs/release-notes.md)" >> changelog_temp.md
        fi
        
        # æ·»åŠ ä¸‹è½½å’Œä½¿ç”¨è¯´æ˜
        cat << 'EOF' >> changelog_temp.md
        
        ### ğŸ“¥ ä¸‹è½½å’Œå®‰è£…
        
        1. **ä¸‹è½½JARæ–‡ä»¶**: ç‚¹å‡»ä¸‹æ–¹ Assets ä¸­çš„ `showMeUCode-${{ steps.version.outputs.version }}.jar`
        2. **å®‰è£…åˆ°Burp Suite**:
           - æ‰“å¼€Burp Suite
           - è¿›å…¥ Extensions æ ‡ç­¾é¡µ
           - ç‚¹å‡» Add æŒ‰é’®
           - é€‰æ‹© Java æ‰©å±•ç±»å‹
           - é€‰æ‹©ä¸‹è½½çš„JARæ–‡ä»¶
           - ç‚¹å‡» Next å®Œæˆå®‰è£…
        
        ### ğŸ¯ åŠŸèƒ½ç‰¹æ€§
        - âœ… è‡ªåŠ¨ä»HTTPè¯·æ±‚ä½“ä¸­æå–çœŸå®æ¥å£åç§°
        - âœ… æ”¯æŒJSONã€XMLã€è¡¨å•æ•°æ®ç­‰å¤šç§æ ¼å¼
        - âœ… æä¾›æ­£åˆ™è¡¨è¾¾å¼ã€JSONè·¯å¾„ã€XPathç­‰æå–è§„åˆ™
        - âœ… å¯è§†åŒ–é…ç½®ç•Œé¢ï¼Œæ”¯æŒè§„åˆ™å¢åˆ æ”¹
        - âœ… é…ç½®å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
        - âœ… æ”¯æŒProxyã€Intruderã€Loggerã€Extensionså·¥å…·ç±»å‹
        
        ### ğŸ“š ä½¿ç”¨æ–‡æ¡£
        - [ç”¨æˆ·æŒ‡å—](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/docs/user-guide.md)
        - [ç¼–è¾‘åŠŸèƒ½æµ‹è¯•æŒ‡å—](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/docs/edit-function-test-guide.md)
        - [é¡¹ç›®README](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/README.md)
        
        ### âš ï¸ ç³»ç»Ÿè¦æ±‚
        - Java 17æˆ–æ›´é«˜ç‰ˆæœ¬
        - Burp Suite Professional/Community 2020.12æˆ–æ›´é«˜ç‰ˆæœ¬
        
        ---
        
        **å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ [Issue](https://github.com/${{ github.repository }}/issues)**
        EOF
        
        # ä¿å­˜å˜æ›´æ—¥å¿—åˆ°æ–‡ä»¶
        echo "å˜æ›´æ—¥å¿—å·²ç”Ÿæˆ"
        
    - name: åˆ›å»ºGitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        release_name: ShowMeUCode v${{ steps.version.outputs.version }}
        body_path: changelog_temp.md
        draft: false
        prerelease: false
        
    - name: ä¸Šä¼ JARæ–‡ä»¶åˆ°Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: target/showMeUCode-${{ steps.version.outputs.version }}.jar
        asset_name: showMeUCode-${{ steps.version.outputs.version }}.jar
        asset_content_type: application/java-archive
        
    - name: ä¸Šä¼ é¡¹ç›®æ–‡æ¡£
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: README.md
        asset_name: README.md
        asset_content_type: text/markdown
        
    - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
      run: |
        echo "ğŸ‰ ç‰ˆæœ¬ ${{ steps.version.outputs.version }} å‘å¸ƒæˆåŠŸï¼"
        echo "ğŸ“¦ Release URL: ${{ steps.create_release.outputs.html_url }}"
        echo "ğŸ“¥ JARä¸‹è½½: ${{ steps.create_release.outputs.html_url }}/download/showMeUCode-${{ steps.version.outputs.version }}.jar"
        echo ""
        echo "ğŸš€ å‘å¸ƒå®Œæˆï¼Œæ‚¨å¯ä»¥ï¼š"
        echo "1. æŸ¥çœ‹Releaseé¡µé¢ç¡®è®¤ä¿¡æ¯"
        echo "2. æµ‹è¯•ä¸‹è½½çš„JARæ–‡ä»¶"
        echo "3. æ›´æ–°é¡¹ç›®æ–‡æ¡£ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯" 